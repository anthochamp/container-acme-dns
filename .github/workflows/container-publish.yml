name: Validate & publish container project

on:
  push:
    branches: [ main ] # edge
    tags: [ 'v[0-9]+.[0-9]+.[0-9]+' ] # versioned

jobs:
  container-validate:
    uses: anthochamp/dev-toolbox/.github/workflows/container-validate.yml@47e334e5d1ebfef7be26a89673feb33c50c6baac

  acme-dns-pre-publish:
    needs: container-validate
    uses: ./.github/workflows/acme-dns-pre-publish.yml
    with:
      build-context: src

  container-publish:
    needs: [container-validate, acme-dns-pre-publish]
    permissions:
      packages: write
      id-token: write # used to complete the identity challenge with sigstore/fulcio
    uses: anthochamp/dev-toolbox/.github/workflows/container-publish.yml@47e334e5d1ebfef7be26a89673feb33c50c6baac
    with:
      build-context: src
      additional-tags: |
        type=edge
        ${{ needs.acme-dns-pre-publish.outputs.additional-tags }}
      ghcr-image-name: ${{ needs.acme-dns-pre-publish.outputs.container-image-name }}
      dhub-image-name: ${{ needs.acme-dns-pre-publish.outputs.container-image-name }}
      dhub-readme-file: ./CONTAINER.md
    secrets:
      dhub-username: ${{ secrets.DHUB_USERNAME }}
      dhub-password: ${{ secrets.DHUB_PASSWORD }}
      ghcr-username: ${{ github.repository_owner }}
      ghcr-password: ${{ secrets.GITHUB_TOKEN }}
